{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/dhanushka/Desktop/survey/src/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nif (!supabaseUrl || !supabaseServiceRoleKey) {\n  throw new Error('Missing Supabase service role environment variables');\n}\n\n// Admin client with service role key (bypasses RLS)\n// Use ONLY in server-side code, NEVER expose to client\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {\n  auth: {\n    persistSession: false,\n    autoRefreshToken: false,\n  },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,yBAAyB,QAAQ,GAAG,CAAC,yBAAyB;AAEpE,IAAI,CAAC,eAAe,CAAC,wBAAwB;IAC3C,MAAM,IAAI,MAAM;AAClB;AAIO,MAAM,gBAAgB,IAAA,8LAAY,EAAC,aAAa,wBAAwB;IAC7E,MAAM;QACJ,gBAAgB;QAChB,kBAAkB;IACpB;AACF"}},
    {"offset": {"line": 25, "column": 0}, "map": {"version":3,"sources":["file:///Users/dhanushka/Desktop/survey/src/actions/tracking.ts"],"sourcesContent":["'use server';\n\nimport { supabaseAdmin } from '@/lib/supabase/admin';\nimport type { SessionTracking, RealtimeStats } from '@/lib/types';\n\nexport async function updateSessionTracking(data: {\n  survey_id: string;\n  session_id: string;\n  current_page: number;\n  question_id?: string;\n}) {\n  try {\n    // Check if session exists\n    const { data: existing, error: fetchError } = await supabaseAdmin\n      .from('session_tracking')\n      .select('*')\n      .eq('survey_id', data.survey_id)\n      .eq('session_id', data.session_id)\n      .single();\n\n    if (fetchError && fetchError.code !== 'PGRST116') {\n      throw fetchError;\n    }\n\n    const now = new Date().toISOString();\n\n    if (existing) {\n      // Calculate time spent on previous question/page\n      const lastActive = new Date(existing.last_active_at);\n      const timeSpentSeconds = Math.floor((Date.now() - lastActive.getTime()) / 1000);\n\n      // Update existing session\n      const { error: updateError } = await supabaseAdmin\n        .from('session_tracking')\n        .update({\n          current_page: data.current_page,\n          question_id: data.question_id || null,\n          time_spent_seconds: existing.time_spent_seconds + timeSpentSeconds,\n          last_active_at: now,\n        })\n        .eq('id', existing.id);\n\n      if (updateError) throw updateError;\n    } else {\n      // Insert new session\n      const { error: insertError } = await supabaseAdmin\n        .from('session_tracking')\n        .insert([\n          {\n            survey_id: data.survey_id,\n            session_id: data.session_id,\n            current_page: data.current_page,\n            question_id: data.question_id || null,\n            time_spent_seconds: 0,\n            last_active_at: now,\n          },\n        ]);\n\n      if (insertError) throw insertError;\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error('Update session tracking error:', error);\n    return { success: false, error: 'Failed to update session tracking' };\n  }\n}\n\nexport async function getActiveSessions(surveyId: string): Promise<{ success: boolean; data?: RealtimeStats; error?: string }> {\n  try {\n    // Get sessions active in last 2 minutes\n    const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();\n\n    const { data: sessions, error } = await supabaseAdmin\n      .from('session_tracking')\n      .select(`\n        *,\n        question:questions(question_text)\n      `)\n      .eq('survey_id', surveyId)\n      .gte('last_active_at', twoMinutesAgo)\n      .order('last_active_at', { ascending: false });\n\n    if (error) throw error;\n\n    // Calculate stats\n    const activeSessions = (sessions || []).map((session: any) => ({\n      session_id: session.session_id,\n      current_page: session.current_page,\n      question_id: session.question_id,\n      question_text: session.question?.question_text,\n      time_spent_seconds: session.time_spent_seconds,\n      last_active_at: session.last_active_at,\n    }));\n\n    const totalTimeSpent = activeSessions.reduce(\n      (sum, session) => sum + session.time_spent_seconds,\n      0\n    );\n\n    const averageTime = activeSessions.length > 0\n      ? totalTimeSpent / activeSessions.length\n      : 0;\n\n    return {\n      success: true,\n      data: {\n        total_active_users: activeSessions.length,\n        active_sessions: activeSessions,\n        average_time_per_question: averageTime,\n      },\n    };\n  } catch (error) {\n    console.error('Get active sessions error:', error);\n    return { success: false, error: 'Failed to fetch active sessions' };\n  }\n}\n\nexport async function cleanupOldSessions() {\n  try {\n    // Remove sessions older than 1 hour\n    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();\n\n    const { error } = await supabaseAdmin\n      .from('session_tracking')\n      .delete()\n      .lt('last_active_at', oneHourAgo);\n\n    if (error) throw error;\n\n    return { success: true };\n  } catch (error) {\n    console.error('Cleanup old sessions error:', error);\n    return { success: false, error: 'Failed to cleanup old sessions' };\n  }\n}\n\n// Track when a user clicks to view media (image/gif)\nexport async function trackMediaView(data: {\n  survey_id: string;\n  question_id: string;\n  session_id: string;\n}) {\n  try {\n    const { error } = await supabaseAdmin\n      .from('media_views')\n      .insert([\n        {\n          survey_id: data.survey_id,\n          question_id: data.question_id,\n          session_id: data.session_id,\n        },\n      ]);\n\n    if (error) throw error;\n\n    return { success: true };\n  } catch (error) {\n    console.error('Track media view error:', error);\n    return { success: false, error: 'Failed to track media view' };\n  }\n}\n\n// Get media view stats for a survey\nexport async function getMediaViewStats(surveyId: string) {\n  try {\n    // First, get all questions with media for this survey\n    const { data: questions, error: questionsError } = await supabaseAdmin\n      .from('questions')\n      .select('id, question_text, media_url')\n      .eq('survey_id', surveyId)\n      .not('media_url', 'is', null);\n\n    if (questionsError) throw questionsError;\n\n    // Then get all media views for this survey\n    const { data: views, error: viewsError } = await supabaseAdmin\n      .from('media_views')\n      .select('question_id')\n      .eq('survey_id', surveyId);\n\n    if (viewsError) throw viewsError;\n\n    // Count views per question\n    const viewCounts: Record<string, number> = {};\n    (views || []).forEach((view: any) => {\n      viewCounts[view.question_id] = (viewCounts[view.question_id] || 0) + 1;\n    });\n\n    // Build stats for all questions with media\n    const stats = (questions || [])\n      .filter((q: any) => q.media_url) // Only questions with media\n      .map((q: any) => ({\n        question_id: q.id,\n        question_text: q.question_text,\n        media_url: q.media_url,\n        view_count: viewCounts[q.id] || 0,\n      }));\n\n    return { \n      success: true, \n      data: stats\n    };\n  } catch (error) {\n    console.error('Get media view stats error:', error);\n    return { success: false, error: 'Failed to fetch media view stats' };\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 213, "column": 0}, "map": {"version":3,"sources":["file:///Users/dhanushka/Desktop/survey/.next-internal/server/app/survey/%5Bid%5D/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {updateSessionTracking as '4085610fbd31f5950682d194e61a6d8f4e1edd0f0f'} from 'ACTIONS_MODULE0'\nexport {trackMediaView as '4017dbf073cb4ec536d5cb3613184aba2d701ff611'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}